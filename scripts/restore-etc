#!/bin/bash

# This script unmounts /etc, mounts a ramfs onto it, and extracts
# /flash/cfg/config.{cur,bak,fac} into it. If an argument is passed, it will be
# used as a local config file and the restoration will proceed from this file.
# Note: this script checks the existence of /etc/config.rc in order to detect
# if a previous config had already been loaded.

# get out of /flash and /etc just in case.
OLDDIR="$PWD"
cd /

export PATH=/bin:/sbin:/usr/bin:/usr/sbin
FLASHDIR=/flash
FLASHCFG=${FLASHDIR}/cfg
FILE=/etc/.restored
EXCLUDE=/usr/share/factory/ignore-files
REFERENCE=/usr/share/factory/base-etc
FORCE=0
VERBOSE=0
CFGFILE=
MOUNTOPT="size=2m"

# Mounts the flash in $FLASHDIR.
# This checks /proc/cmdline for the LAST 'flash=' statement, and
# uses its value as a /dev entry to mount it read-only into $FLASHDIR.
# Returns 0 if OK, 1 otherwise.
# DOES NOT unmounts $FLASHDIR first if previously mounted, but returns with
# an error indicating a resource access conflict.
mount_flash_ro() {
  local flash

  unset FLASH_MBR FLASH_HW FLASH_SW

  if [ -s /var/state/flash-layout.rc ]; then
    . /var/state/flash-layout.rc
  fi

  if [ -z "$FLASH_SW" ]; then
    if [ -x /sbin/mk-flash-layout ]; then
      /sbin/mk-flash-layout -k && return 0
      if [ -s /var/state/flash-layout.rc ]; then
        . /var/state/flash-layout.rc
      fi
    fi
  fi

  if [ -z "$FLASH_SW" ]; then
    flash="$(cat /proc/cmdline)"
    if [ -n "${flash##*flash=*}" ]; then
      echo "No flash device specified in /proc/cmdline."
      return 1
    fi
    flash=${flash##*flash=}
    flash=${flash%% *}
    [ -n "${flash##/dev/*}" ] && flash="/dev/$flash"
  else
    flash=$FLASH_SW
  fi

  echo "Mounting ${flash} on $FLASHDIR..."
  cd /
  umount -n -d $FLASHDIR >/dev/null 2>&1
  if ! mount -n -r $flash $FLASHDIR >/dev/null 2>&1; then
    echo "Error: mount failed."
    return 1
  fi
  return 0
}

# unmounts /flash
umount_flash() {
  if ! umount -d $FLASHDIR >/dev/null 2>&1; then
    cd /
    if ! umount -d $FLASHDIR >/dev/null 2>&1; then
      echo "Error: cannot unmount $FLASHDIR"
      return 1
    else
      echo "Warning: ${0##*/} forgot to leave $FLASHDIR before unmounting it."
    fi
  fi
  return 0
}

# copies /flash/fstab to /etc if /etc/fstab is missing
copy_fstab_from_flash() {
  if [ ! -s /etc/fstab -a -s $FLASHDIR/fstab ]; then
    # missing fstab and we have one lying in /flash. This is the one we want to use.
    echo "Note: using original fstab until configuration is saved."
    cp $FLASHDIR/fstab /etc/fstab && chown root:adm /etc/fstab && chmod 640 /etc/fstab
  fi
}

# creates a secure empty temporary directory and returns its full path name.
# Returns 0 if it succeeds, with the name on stdout, otherwise returns 1.
mkstemp() {
  local name attempts=10
  while [ $attempts -gt 0 ]; do
    name="${TMPDIR-/tmp}/$$.$RANDOM.$attempts"
    if mkdir -m 0700 $name >/dev/null 2>/dev/null; then
      echo "$name"
      return 0
    fi
    rmdir $name >/dev/null 2>/dev/null
    ((attempts--))
  done
  return 1
}

# Checks what has changed since last backup. We need to use 'tar cf' because
# we want to benefit from tar's ability to exclude files from another file.
# The changed files are listed on stdout, relative to /.
# WARNING! because it uses tar, it does not detect removed files.
list_changes() {
  if [ -r "$FILE" ]; then
    flx check --ignore-dot --ignore-link --ignore-date file:$FILE fs:/etc \
      | awk '/^[+>]/ { print $9 }' \
      | tar -C / -T - --one-file-system --numeric-owner --no-recursion --exclude-from $EXCLUDE -cvf /dev/null 2>/dev/null
  else
      tar -C / --one-file-system --numeric-owner --exclude-from $EXCLUDE -cvf /dev/null etc 2>/dev/null
  fi
}

# kills the program and outputs an error if provided.
function die {
    local ret="$1"
    shift
    [ -n "$*" ] && echo "$@" >&2
    exit $ret
}

while [ $# -gt 0 ]; do
  if [ ".$1" = ".-f" ]; then FORCE=1
  elif [ ".$1" = ".-v" ]; then VERBOSE=1
  elif [ "${1}" != "-" -a -z "${1##-*}" ]; then
    echo "Unknown argument: $1"
    echo "Valid options are :"
    echo "  -f : force update and ignore local changes ;"
    echo "  -v : only check whether files have been modified ;"
    echo "  <file> : restore from this file instead of flash. Use '-' for stdin."
    exit 1
  else
    break
  fi
  shift
done

if [ $# -gt 0 ]; then
  CFGFILE="$1"
  [ -n "${CFGFILE##/*}" -a "${CFGFILE}" != "-" ] && CFGFILE="$OLDDIR/$CFGFILE"
  shift
fi

if [ $VERBOSE -eq 1 ]; then
  echo "List of files modified since last backup."
  rm -f /etc/blkid.tab{,.old} 2>/dev/null
  flx check --ignore-dot file:$FILE fs:/etc | grep -vwF "${FILE#/}"
  exit 0
fi

if [ $FORCE -eq 0 -a -e $FILE ] && \
   [ $(list_changes | wc -l) -gt 0 ]; then
  echo "Some files have changed since last backup. Check them with '-v' or use '-f'."
  exit 1;
fi 

# restore from local file ?
if [ -n "$CFGFILE" ]; then
  unset temp_cfg_dir
  if [ "$CFGFILE" = "-" ]; then
    # restore from stdin
    temp_cfg_dir="$(mkstemp)" || die 1 "Cannot create a temporary directory in '${TMPDIR-/tmp}'."
    cat > "$temp_cfg_dir/stdin"
    if [ -s "$temp_cfg_dir/stdin" ] && [ $(tar ztf "$temp_cfg_dir/stdin" 2>/dev/null|wc -l) -gt 0 ]; then
	CFGFILE="$temp_cfg_dir/stdin"
    fi
  fi
  if [ -s "$CFGFILE" ] && [ $(tar ztf "$CFGFILE" 2>/dev/null|wc -l) -gt 0 ]; then
    if [ -e /etc/config.rc ]; then
      while umount /etc >/dev/null 2>&1; do : ; done
    fi

    if [ ! -e /etc/config.rc ]; then
      mount -n -t ramfs ${MOUNTOPT:+-o $MOUNTOPT} /etc /etc || \
        mount -n -t ramfs /etc /etc
    fi
    (tar -C $REFERENCE --one-file-system -cf - . | tar -C /etc -xf -) >/dev/null 2>&1
    # first, we want to remove all directories from /etc which are replaced
    # by something not a directory in the archive (typically a symlink). Directories
    # in the file must not be removed since they may carry only few files.
    tar ztf "$CFGFILE" etc/ | grep -v '/$' | tr '\012' '\000' | (cd / && xargs -r0 rm -rf) 2>&1
    tar -C /etc --exclude-from $EXCLUDE --strip-components=1 -zxf "$CFGFILE" >/dev/null 2>&1
    # ignore the return code, because some files may come with extra CR/LF.
    if [ -s /etc/config.rc ]; then
      ( rm -f /etc/blkid.tab{,.old}; \
        rm -f $FILE ; touch $FILE ; chmod 600 $FILE; \
        flx sign --ignore-dot /etc | grep -vwF "${FILE#/}" >$FILE ) >/dev/null 2>&1
      echo "$CFGFILE"
      [ -n "$temp_cfg_dir" ] && rm -rf "$temp_cfg_dir"
      exit 0
    fi
    while umount /etc >/dev/null 2>&1; do : ; done
  fi
  [ -n "$temp_cfg_dir" ] && rm -rf "$temp_cfg_dir"
fi

must_unmount=0

# if we get any error there, we try to restore the flash configuration.
if mount_flash_ro; then
  for config in $FLASHCFG/config.cur $FLASHCFG/config.bak $FLASHCFG/config.fac
  do
    if [ -s $config ] && [ $(tar ztf $config 2>/dev/null|wc -l) -gt 0 ]; then
      if [ -e /etc/config.rc ]; then
        while umount /etc >/dev/null 2>&1; do : ; done
      fi
      if [ ! -e /etc/config.rc ]; then
        mount -n -t ramfs ${MOUNTOPT:+-o $MOUNTOPT} /etc /etc || \
          mount -n -t ramfs /etc /etc
      fi
      (tar -C $REFERENCE --one-file-system -cf - . | tar -C /etc -xf -) >/dev/null 2>&1
      # first, we want to remove all directories from /etc which are replaced
      # by something not a directory in the archive (typically a symlink). Directories
      # in the file must not be removed since they may carry only few files.
      tar ztf "$config" etc/ | grep -v '/$' | tr '\012' '\000' | (cd / && xargs -r0 rm -rf) 2>&1
      tar -C /etc --exclude-from $EXCLUDE --strip-components=1 -zxf $config >/dev/null 2>&1
      if [ $? -eq 0 -a -s /etc/config.rc ]; then
        copy_fstab_from_flash
        umount_flash
        ( rm -f /etc/blkid.tab{,.old}; \
          rm -f $FILE ; touch $FILE ; chmod 600 $FILE; \
          flx sign --ignore-dot /etc | grep -vwF "${FILE#/}" >$FILE ) >/dev/null 2>&1
        echo ${config##*/}
        exit 0
      fi
      while umount /etc >/dev/null 2>&1; do : ; done
    fi
  done
  must_unmount=1
  rm -f /etc/blkid.tab{,.old} >/dev/null 2>&1
fi

# We have not found any config, so we'll build /etc from the reference etc
# directory into a ramfs anyway so that we get a read/write /etc.
if [ -e /etc/config.rc ]; then
  while umount /etc >/dev/null 2>&1; do : ; done
fi
if [ ! -e /etc/config.rc ]; then
  mount -n -t ramfs ${MOUNTOPT:+-o $MOUNTOPT} /etc /etc || \
    mount -n -t ramfs /etc /etc 2>/dev/null || exit 1  # already mounted
fi
(tar -C $REFERENCE --one-file-system -cf - . | tar -C /etc -xf -) >/dev/null 2>&1
( rm -f $FILE ; touch $FILE ; chmod 600 $FILE ) >/dev/null 2>&1
( copy_fstab_from_flash ) >/dev/null 2>&1
[ $must_unmount -eq 0 ] || umount_flash

( flx sign --ignore-dot /etc | grep -vwF "${FILE#/}" >$FILE ) >/dev/null 2>&1
rm -f /etc/blkid.tab{,.old} >/dev/null 2>&1
exit 1
